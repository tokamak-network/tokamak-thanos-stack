{{- if .Values.kube-prometheus-stack.alertmanager.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "monitoring.labels" . | nindent 4 }}
type: Opaque
stringData:
  alertmanager.yml: |
    global:
      # Telegram Bot API URL
      telegram_api_url: 'https://api.telegram.org'
      {{- if .Values.alertmanager.email.enabled }}
      # Email fallback configuration
      smtp_smarthost: {{ .Values.alertmanager.email.smtp_smarthost | quote }}
      smtp_from: {{ .Values.alertmanager.email.smtp_from | quote }}
      {{- if .Values.alertmanager.email.smtp_auth_username }}
      smtp_auth_username: {{ .Values.alertmanager.email.smtp_auth_username | quote }}
      {{- end }}
      {{- if .Values.alertmanager.email.smtp_auth_password }}
      smtp_auth_password: {{ .Values.alertmanager.email.smtp_auth_password | quote }}
      {{- end }}
      smtp_require_tls: true
      {{- end }}

    # Alert routing configuration (Critical only)
    route:
      group_by: {{ .Values.alertmanager.routing.group_by | toJson }}
      group_wait: {{ .Values.alertmanager.routing.group_wait }}
      group_interval: {{ .Values.alertmanager.routing.group_interval }}
      repeat_interval: {{ .Values.alertmanager.routing.repeat_interval }}
      receiver: 'null'  # Default to null (ignore non-critical)
      routes:
        - match:
            severity: critical
          receiver: 'telegram-critical'
          group_wait: 10s
          group_interval: 1m
          repeat_interval: 1h
        - match:
            alertname: DeadMansSwitch
          receiver: 'null'

    # Alert inhibition rules (simplified for critical only)
    inhibit_rules:
      {{- range .Values.alertmanager.inhibit_rules }}
      - source_match:
          {{- range $key, $value := .source_match }}
          {{ $key }}: {{ $value | quote }}
          {{- end }}
        target_match:
          {{- range $key, $value := .target_match }}
          {{ $key }}: {{ $value | quote }}
          {{- end }}
        equal: {{ .equal | toJson }}
      {{- end }}

    # Telegram receivers configuration
    receivers:
      - name: 'null'
      
      - name: 'telegram-critical'
        {{- if .Values.alertmanager.telegram.enabled }}
        telegram_configs:
          {{- range .Values.alertmanager.telegram.critical_receivers }}
          {{- if .chat_id }}
          - api_url: 'https://api.telegram.org'
            bot_token: {{ $.Values.alertmanager.telegram.api_token | quote }}
            chat_id: {{ .chat_id | quote }}
            message: |
              ğŸš¨ *CRITICAL ALERT - Immediate Action Required* ğŸš¨
              
              *Chain:* {{ $.Values.thanosStack.chainName }}
              *Namespace:* {{ $.Values.thanosStack.namespace }}
              
              {{`{{ range .Alerts }}`}}
              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
              *Alert:* {{`{{ .Annotations.summary }}`}}
              *Description:* {{`{{ .Annotations.description }}`}}
              *Severity:* {{`{{ .Labels.severity | upper }}`}}
              *Component:* {{`{{ .Labels.job }}`}}
              *Instance:* {{`{{ .Labels.instance }}`}}
              *Started:* {{`{{ .StartsAt | humanizeTimestamp }}`}}
              {{`{{ if .Annotations.runbook_url }}`}}
              *Runbook:* {{`{{ .Annotations.runbook_url }}`}}
              {{`{{ end }}`}}
              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
              {{`{{ end }}`}}
              
              âš¡ *Please investigate immediately and take necessary action!*
            parse_mode: 'Markdown'
            disable_web_page_preview: true
          {{- end }}
          {{- end }}
        {{- end }}
        {{- if .Values.alertmanager.email.enabled }}
        email_configs:
          {{- range .Values.alertmanager.email.critical_receivers }}
          {{- if . }}
          - to: {{ . | quote }}
            subject: '[CRITICAL - Thanos Stack] ğŸš¨ {{`{{ .GroupLabels.alertname }}`}}'
            body: |
              ğŸš¨ CRITICAL ALERT - Immediate Action Required ğŸš¨
              
              Chain: {{ $.Values.thanosStack.chainName }}
              Namespace: {{ $.Values.thanosStack.namespace }}
              
              {{`{{ range .Alerts }}`}}
              ================================
              Alert: {{`{{ .Annotations.summary }}`}}
              Description: {{`{{ .Annotations.description }}`}}
              Severity: {{`{{ .Labels.severity }}`}}
              Component: {{`{{ .Labels.job }}`}}
              Instance: {{`{{ .Labels.instance }}`}}
              Started: {{`{{ .StartsAt }}`}}
              
              {{`{{ if .Annotations.runbook_url }}`}}
              Runbook: {{`{{ .Annotations.runbook_url }}`}}
              {{`{{ end }}`}}
              ================================
              {{`{{ end }}`}}
              
              Please investigate immediately and take necessary action.
          {{- end }}
          {{- end }}
        {{- end }}
{{- end }} 